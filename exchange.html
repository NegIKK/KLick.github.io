<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Биржа | Z‑майнинг</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23, #1a1a3e);
            color: #e0e0e0;
            font-family: 'Ithaca', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            background: rgba(25, 25, 45, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            backdrop-filter: blur(10px);
        }
        h2 {
            color: #00ffff;
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 0 10px #00ffff;
        }
        .balance-section {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        .balance-item {
            text-align: center;
        }
        .balance-label {
            font-size: 1em;
            color: #88d0ff;
        }
        .balance-value {
            font-size: 1.4em;
            color: #ffffff;
            margin-top: 5px;
        }
        .rate-section {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 180, 255, 0.1);
            border-radius: 12px;
            border: 1px solid #00b3ff;
        }
        .rate-label {
            font-size: 1.1em;
            color: #aaa;
        }
        .rate-value {
            font-size: 1.6em;
            color: #00c6ff;
            margin: 10px 0;
        }
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-buy {
            background: linear-gradient(45deg, #00b3ff, #0077ff);
            color: white;
        }
        .btn-sell {
            background: linear-gradient(45deg, #ff6b6b, #ff3b3b);
            color: white;
        }
        .btn-return {
            background: linear-gradient(45deg, #4caf50, #2e7d32);
            color: white;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        #chartContainer {
            margin-top: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #aaa;
            font-size: 0.9em;
        }
        /* Индикатор режима */
        #exchangeModeIndicator {
            display: block;
            text-align: center;
            color: #ff9900;
            font-size: 0.9em;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 153, 0, 0.1);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Индикатор режима -->
    <div id="exchangeModeIndicator">
        Режим биржи активен. Обновления игры приостановлены.
    </div>

    <div class="container">
        <h2>Z-Биржа</h2>

        <!-- Баланс игрока -->
        <div class="balance-section">
            <div class="balance-item">
                <div class="balance-label">Ваш BTC</div>
                <div id="btcBalance" class="balance-value">0.00000000</div>
            </div>
            <div class="balance-item">
                <div class="balance-label">Ваш USD</div>
                <div id="usdBalance" class="balance-value">10.00</div>
            </div>
        </div>

        <!-- Текущий курс BTC/USD -->
        <div class="rate-section">
            <div class="rate-label">Текущий курс BTC → USD</div>
            <div id="btcUsdRate" class="rate-value">Загрузка...</div>
            <div id="lastUpdated" style="font-size: 0.8em; color: #888;">—</div>
        </div>

        <!-- Кнопки действий -->
        <div class="actions">
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" id="buyAmount" placeholder="Кол-во BTC" step="0.00000001" min="0" style="width: 120px; padding: 8px; border-radius: 8px;">
                <button class="btn-buy" onclick="buyBTC()">Купить BTC</button>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="number" id="sellAmount" placeholder="Кол-во BTC" step="0.00000001" min="0" style="width: 120px; padding: 8px; border-radius: 8px;">
                <button class="btn-sell" onclick="sellBTC()">Продать BTC</button>
            </div>
            <!-- Кнопка возврата -->
            <button class="btn-return" onclick="returnToGame()">Вернуться в Z‑майнинг</button>
        </div>

        <!-- График BTC/USD -->
        <div id="chartContainer">
            <canvas id="btcChart" height="200"></canvas>
        </div>

<div class="footer">
    <p>Биржа обновляется каждые 10 секунд. Курс берётся из CoinGecko API.</p>

    <div id="tradeHistorySection" style="margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
        <h4 style="color: #88d0ff; margin-bottom: 10px;">История сделок</h4>
        <ul id="tradeHistoryList" style="list-style: none; padding: 0; margin: 0;">
            <!-- Сюда будут подставляться записи -->
        </ul>
        <p id="noTrades" style="color: #888; font-style: italic; display: none;">Нет совершённых сделок</p>
    </div>
</div>

    </div>

    <script>
        // Глобальные переменные
		let tradeHistory = []; // Массив для хранения истории сделок
        let gameData = {};
        let BTC_TO_USD_RATE = null;
        let chart = null;
        let priceHistory = []; // История цен (время, цена)

        // Загрузка данных из localStorage
        function loadGame() {
            const saved = localStorage.getItem('zMining');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    gameData = {
                        usdBalance: typeof parsed.usdBalance === 'number' ? parsed.usdBalance : 1,
                        btcBalance: typeof parsed.btcBalance === 'number' ? parsed.btcBalance : 0
                    };
                    console.log('Данные загружены:', gameData);
                } catch (error) {
                    console.error('Ошибка парсинга localStorage:', error);
                    gameData = { usdBalance: 1, btcBalance: 0 };
                }
            } else {
                gameData = { usdBalance: 1, btcBalance: 0 };
                console.log('Дефолтные данные:', gameData);
            }
        }

        // Обновление интерфейса
        function updateUI() {
            const btcElement = document.getElementById('btcBalance');
            const usdElement = document.getElementById('usdBalance');

            if (!btcElement || !usdElement) return;

            btcElement.textContent = gameData.btcBalance.toFixed(8);
            usdElement.textContent = gameData.usdBalance.toFixed(2);

            document.getElementById('btcUsdRate').textContent = BTC_TO_USD_RATE
                ? `$${BTC_TO_USD_RATE.toFixed(2)}`
                : 'Ошибка';
        }

        // Получение курса BTC/USD
        async function fetchBTCCourse() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                BTC_TO_USD_RATE = data.bitcoin.usd;

                updateUI();
                updateChart();

                const now = new Date();
                priceHistory.push({
                    time: now.toLocaleTimeString(),
                    price: BTC_TO_USD_RATE
                });

                if (priceHistory.length > 10) {
                    priceHistory.shift();
                }

                document.getElementById('lastUpdated').textContent = `Обновлено: ${now.toLocaleTimeString()}`;
            } catch (error) {
                console.error('Ошибка загрузки курса BTC:', error);
                BTC_TO_USD_RATE = BTC_TO_USD_RATE || 42000;
                updateUI();
            }
        }

        // Инициализация графика
        function initChart() {
            const ctx = document.getElementById('btcChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'BTC/USD ($)',
                        data: [],
                        borderColor: '#00c6ff',
                        backgroundColor: 'rgba(0, 198, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#aaa' },
                            bounds: 'data'
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#aaa' },
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e0e0e0' } },
                        tooltip: { mode: 'index' }
                    }
                }
            });
        }

        // Обновление графика
        function updateChart() {
            if (!chart) return;

            chart.data.labels = priceHistory.map(point => point.time);
            chart.data.datasets[0].data = priceHistory.map(point => point.price);
            chart.update('quiet');
        }

        // Покупка BTC
        function buyBTC() {
            if (!BTC_TO_USD_RATE) {
                alert('Курс BTC недоступен. Попробуйте позже.');
                return;
            }

            const input = document.getElementById('buyAmount');
            const amountBTC = parseFloat(input.value);

            if (isNaN(amountBTC) || amountBTC <= 0) {
                alert('Введите положительное число BTC!');
                return;
            }

            const costUSD = amountBTC * BTC_TO_USD_RATE;

            if (gameData.usdBalance < costUSD) {
                alert(`Недостаточно USD! Требуется: ${costUSD.toFixed(2)} USD. Ваш баланс: ${gameData.usdBalance.toFixed(2)} USD.`);
                return;
            }

            gameData.usdBalance = Math.round((gameData.usdBalance - costUSD) * 100) / 100;
            gameData.btcBalance = Math.round((gameData.btcBalance + amountBTC) * 100000000) / 100000000;

            saveGame();
			
			// Добавляем запись в историю
tradeHistory.push({
    type: 'buy',
    timestamp: Date.now(),
    btcAmount: amountBTC,
    usdTotal: costUSD,
    rate: BTC_TO_USD_RATE
});

// Сохраняем историю в localStorage
localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));

// Обновляем отображение
renderTradeHistory();

            updateUI();
            alert(`Куплено ${amountBTC.toFixed(8)} BTC за ${costUSD.toFixed(2)} USD!`);
            input.value = '';
        }

        // Продажа BTC
        function sellBTC() {
            if (!BTC_TO_USD_RATE) {
                alert('Курс BTC недоступен. Попробуйте позже.');
                return;
            }

            const input = document.getElementById('sellAmount');
            const amountBTC = parseFloat(input.value);

            if (isNaN(amountBTC) || amountBTC <= 0) {
                alert('Введите положительное число BTC!');
                return;
            }

            if (gameData.btcBalance < amountBTC) {
                alert(`Недостаточно BTC! У вас: ${gameData.btcBalance.toFixed(8)} BTC.`);
                return;
            }

            const revenueUSD = amountBTC * BTC_TO_USD_RATE;
            gameData.btcBalance = Math.round((gameData.btcBalance - amountBTC) * 100000000) / 100000000;
            gameData.usdBalance = Math.round((gameData.usdBalance + revenueUSD) * 100) / 100;

            saveGame();
			
			// Добавляем запись в историю
tradeHistory.push({
    type: 'sell',
    timestamp: Date.now(),
    btcAmount: amountBTC,
    usdTotal: revenueUSD,
    rate: BTC_TO_USD_RATE
});

// Сохраняем историю в localStorage
localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));

// Обновляем отображение
renderTradeHistory();
			
            updateUI();
            alert(`Продано ${amountBTC.toFixed(8)} BTC за ${revenueUSD.toFixed(2)} USD!`);
            input.value = '';
        }

        // Сохранение в localStorage
        function saveGame() {
            try {
                const saved = localStorage.getItem('zMining');
                let gameState = saved ? JSON.parse(saved) : {};

                gameState.usdBalance = gameData.usdBalance;
                gameState.btcBalance = gameData.btcBalance;

                localStorage.setItem('zMining', JSON.stringify(gameState));
                console.log('Сохранено в localStorage:', gameState);
            } catch (error) {
                console.error('Ошибка сохранения в localStorage:', error);
            }
        }

        // Возврат в основную игру
        function returnToGame() {
            // Сохраняем текущий прогресс
            saveGame();

            // Открываем главную страницу (предполагается, что она называется index.html)
            window.open('index.html', '_self');

            // Закрываем текущее окно (опционально)
            window.close();
        }

        // Синхронизация с localStorage
        function syncWithMainGame() {
            const saved = localStorage.getItem('zMining');
            if (!saved) {
                console.warn('Нет данных в localStorage');
                return;
            }

            try {
                const newData = JSON.parse(saved);

                // Обновляем только ключевые балансы
                if (typeof newData.usdBalance !== 'undefined') {
                    gameData.usdBalance = parseFloat(newData.usdBalance);
                }
                if (typeof newData.btcBalance !== 'undefined') {
                    gameData.btcBalance = parseFloat(newData.btcBalance);
                }

                console.log('Синхронизация: USD=', gameData.usdBalance, 'BTC=', gameData.btcBalance);
                updateUI(); // Перерисовываем интерфейс
            } catch (error) {
                console.error('Ошибка парсинга localStorage:', error);
            }
        }

        // Инициализация при загрузке страницы
        window.addEventListener('load', () => {
            // Загружаем историю из localStorage
const savedHistory = localStorage.getItem('tradeHistory');
if (savedHistory) {
    try {
        tradeHistory = JSON.parse(savedHistory);
        console.log('История сделок загружена:', tradeHistory);
    } catch (error) {
        console.error('Ошибка парсинга истории сделок:', error);
        tradeHistory = [];
    }
} else {
    tradeHistory = [];
}

// Отображаем историю
renderTradeHistory();
			
			// Активируем режим биржи
            console.log('Режим биржи активирован — обновления игры приостановлены');


            loadGame();
            initChart();

            fetchBTCCourse();
            setInterval(fetchBTCCourse, 10000); // Каждые 10 секунд
            setInterval(syncWithMainGame, 5000);  // Каждые 5 секунд


            console.log('Биржа запущена');
        });

        // Обработчик закрытия окна (опционально)
        window.addEventListener('beforeunload', () => {
            console.log('Окно биржи закрыто');
        });
		
		function renderTradeHistory() {
    const historyList = document.getElementById('tradeHistoryList');
    const noTrades = document.getElementById('noTrades');

    // Очищаем список
    historyList.innerHTML = '';

    if (tradeHistory.length === 0) {
        noTrades.style.display = 'block';
        return;
    }

    noTrades.style.display = 'none';

    // Берём последние 5 сделок (самые свежие)
    const recentTrades = tradeHistory.slice(-5).reverse();

    recentTrades.forEach(trade => {
        const li = document.createElement('li');
        li.style.padding = '8px 0';
        li.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';

        // Форматируем время
        const date = new Date(trade.timestamp);
        const timeStr = date.toLocaleTimeString('ru-RU');

        // Тип операции и цвет
        const typeLabel = trade.type === 'buy' ? 'Покупка' : 'Продажа';
        const color = trade.type === 'buy' ? '#4caf50' : '#f44336';

        // Текст строки
        li.innerHTML = `
            <span style="color: ${color}; font-weight: bold;">[${typeLabel}]</span> 
            ${timeStr}<br>
            <span style="font-size: 0.9em; color: #aaa;">
                ${trade.btcAmount.toFixed(8)} BTC × ${trade.rate.toFixed(2)} $/BTC = 
                <strong>${trade.usdTotal.toFixed(2)} USD</strong>
            </span>
        `;

        historyList.appendChild(li);
    });
}

    </script>
</body>
</html>
